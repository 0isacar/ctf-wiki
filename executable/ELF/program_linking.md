# 程序链接

# 静态链接

# 动态链接

动态链接主要是在程序初始化时或者程序执行的过程中解析变量或者函数的引用。ELF文件中某些节区以及头部元素就与动态链接有关。动态链接的模型由操作系统定义并实现。

## Program Interpreter

参与动态链接的可执行文件应该具有一个PT_INTERP类型的程序头元素。在exec (BA_OS)过程中，系统会从PT_INTERP中提取一个路径名，并从解释器文件的段创建初始时的程序镜像。也就是输，系统并不使用原始的可执行文件的镜像，而会为解释器构造一个内存镜像。因此，解释器有责任从系统处获取控制权，然后为应用程序提供执行环境。

解释器从两个方面获取控制权。首先，它会接收到一个指向文件头的文件描述符来读取可执行文件。它可以使用这个文件描述符来读取以及将可执行文件的段映射到内存中。其次，有时候根据可执行文件格式的不同，系统有可能不会把文件描述符给解释器，而是会直接将可执行文件加载到内存中。文件描述符可能会出现异常，但是解释器的初始状态仍然会与可执行文件的收到的相匹配，解释器本身不需要再有一个解释器。解释器本身可能是一个共享目标文件或者是一个可执行文件。

- 共享目标文件（正常情况下）被加载为位置独立的，也就是说，对于不同的进程来说，它的地址会有所不同。系统通过mmap (KE_OS)以及一些相关的操作来创建动态段中的内容。因此，共享目标文件的地址通常来说不会和原来的可执行文件的原有地址冲突。
- 可执行文件会被加载到固定的地址。系统通过程序头部表的虚拟地址来创建对应的段。因此，一个可执行文件的解释器的虚拟地址可能和第一个可执行文件冲突。解释器有责任来解决相应的冲突。

## Dynamic Linker

当使用动态链接来构造程序时，链接编辑器会在可执行文件的程序头部添加一个PT_INTERP类型的元素，以便于告诉系统将动态连接器作为程序解释器来调用。

> 需要注意的是，对于系统提供的动态链接器，不同的系统会不同。

可执行程序和动态链接器会合作起来为程序创建进程镜像，具体的细节如下：

1. 将可执行文件的内存段添加到进程镜像中。
2. 将共享目标文件的内存端添加到进程镜像中。
3. 为可执行文件以及共享目标文件进行重定位。
4. 如果传递给了动态链接器一个文件描述符的话，就将其关闭。
5. 将控制权传递给程序，就好像程序直接从可执行文件处拿到了执行权限。

链接编辑器同样也创建了各种各样的数据来协助动态连接器来处理可执行文件和共享目标文件，例如

- 类型为SHT_DYNAMIC的节.dynamic包含了各种各样的数据，在这个节的开始处包含了其它动态链接的信息。
- 类型为SHT_HASH的节.hash包含了符号哈希表。
- 类型为SHT_PROGBITS的节.got以及.plt包含了两个独立的表：全局偏移表，以及过程链接表。程序会利用过程链接表来处理位置独立代码。

因为所有的UNIX System V都会从一个共享目标文件中导入基本的系统服务，动态连接器会参与到每一个TIS ELF-conforming的程序执行过程中。

正如程序加载中所说的，共享目标文件中可能会占用与程序头部中记录的不一样的虚拟地址。动态连接器会在程序拿到控制权前，重定位内存镜像，更新绝对地址。如果共享目标文件确实加载到了其在程序头部中指定的地址的话，那么那些绝对地址的值就会使正确的。但通常情况下，这种情况不会发生。

如果进程的环境中有名叫LD_BIND_NOW的非空值，那么动态连接器在把权限传递给程序时，会执行所有的重定位。例如，所有的如下环境变量的取值都会专门指定这一行为。

- LD_BIND_NOW = 1
- LD_BIND_NOW = on
- LD_BIND_NOW = off

否则，LD_BIND_NOW要么不存在于当前的进程环境中，要么具有一个非空值。动态连接器可以延迟解析过程链接表的入口，这其实就是plt表的延迟绑定，即当程序需要使用某个符号时，再进行地址解析，这可以减少符号解析以及重定位的负载。

## Dynamic Section

如果一个目标文件参与到动态链接的过程中，那么它的程序头部表将会包含一个类型为PT_DYNAMIC的元素。这个段包含了.dynamic节。_DYNAMIC符号会用来标记这个节，它的结构如下

```c++
typedef struct {
	Elf32_Sword		d_tag;
	union {
		Elf32_Word	d_val;
		Elf32_Addr	d_ptr;
	} d_un;
} Elf32_Dyn;

extern Elf32_Dyn_DYNAMIC[];
```

其中，d_tag控制着d_un的解释。

- d_val
  - 这个字段表示一个整数值，可以有多种意思。
- d_ptr
  - 这个字段表示程序的虚拟地址。正如之前所说的，一个文件的虚拟地址在执行的过程中可能和内存的虚拟地址不匹配。当解释动态结构中的地址时，动态连接器会根据原始文件的值以及内存的基地址来计算真正的地址。为了保持一致性，文件中并不会包含重定位入口来"纠正"动态结构中的地址。


下表总结了可执行文件以及共享目标文件中的d_tag的需求。如果一个tag被标记为"mandatory"，那么对于一个TIS ELF conforming的文件来说，其动态链接数组必须包含对应入口的类型。同样的，“optional”意味着可以有，也可以有没有。

| 名称                    | 数值                     | d_un  | 可执行  | 共享 目标 | 说明                                       |
| --------------------- | ---------------------- | ----- | ---- | ----- | ---------------------------------------- |
| DT_NULL               | 0                      | 忽略    | 必需   | 必需    | 标志着 \_DYNAMIC 数组的末端。                     |
| DT_NEEDED             | 1                      | d_val | 可选   | 可选    | 包含以NULL 结尾的字符串的字符串表偏移，该字符串给出某个需要的库的名称。所使用的索引为DT_STRTAB的下标。动态数组中可以包含很多个这种类型的标记。这些项在这种类型标记中的相对顺序比较重要。但是与其它的标记之前的顺序倒无所谓。 |
| DT_PLTRELSZ           | 2                      | d_val | 可选   | 可选    | 给出与过程链接表相关的重定位项的总的大小。如果存在DT_JMPREL类型的项，那么DT_PLTRELSZ也必须存在。 |
| DT_PLTGOT             | 3                      | d_ptr | 可选   | 可选    | 给出与过程链接表或者全局偏移表相关联的地址。                   |
| DT_HASH               | 4                      | d_ptr | 必需   | 必需    | 此类型表项包含符号哈希表的地址。此哈希表指的是被 DT_SYMTAB 引用的符号表。 |
| DT_STRTAB             | 5                      | d_ptr | 必需   | 必需    | 此类型表项包含字符串表的地址。符号名、库名、和其它字符串都包含在此表中。     |
| DT_SYMTAB             | 6                      | d_ptr | 必需   | 必需    | 此类型表项包含符号表的地址。对 32 位的文件而言，这个符号表中的条目的类型为 Elf32_Sym。 |
| DT_RELA               | 7                      | d_ptr | 必需   | 可选    | 此类型表项包含重定位表的地址。此表中的元素包含显式的补齐，例如 32 位文件中的 Elf32_Rela。目标文件可能有多个重定位节区。在为可执行文件或者共享目标文件创建重定位表时，链接编辑器将这些节区连接起来，形成一个表。尽管在目标文件中这些节区相互独立，但是动态链接器把它们视为一个表。在动态链接器为可执行文件创建进程映像或者向一个进程映像中添加某个共享目标时，要读取重定位表并执行相关的动作。如果此元素存在，动态结构体中也必须包含 DT_RELASZ 和 DT_RELAENT 元素。如果对于某个文件来说，重定位是必需的话，那么 DT_RELA 或者 DT_REL 都可能存在。 |
| DT_RELASZ             | 8                      | d_val | 必需   | 可选    | 此类型表项包含 DT_RELA 重定位表的总字节大小。              |
| DT_RELAENT            | 9                      | d_val | 必需   | 可选    | 此类型表项包含 DT_RELA 重定位项的字节大小。               |
| DT_STRSZ              | 10                     | d_val | 必需   | 必需    | 此类型表项给出字符串表的字节大小，按字节数计算。                 |
| DT_SYMENT             | 11                     | d_val | 必需   | 必需    | 此类型表项给出符号表项的字节大小。                        |
| DT_INIT               | 12                     | d_ptr | 可选   | 可选    | 此类型表项给出初始化函数的地址。                         |
| DT_FINI               | 13                     | d_ptr | 可选   | 可选    | 此类型表项给出结束函数（Termination Function）的地址。    |
| DT_SONAME             | 14                     | d_val | 忽略   | 可选    | 此类型表项给出一个以 NULL 结尾的字符串的字符串表偏移，对应的字符串是某个共享目标的名称。该偏移实际上是 DT_STRTAB 中的索引。 |
| DT_RPATH              | 15                     | d_val | 可选   | 忽略    | 此类型表项包含以 NULL 结尾的字符串的字符串表偏移，对应的字符串是搜索库时使用的搜索路径。该偏移实际上是 DT_STRTAB 中的索引。 |
| DT_SYMBOLIC           | 16                     | 忽略    | 忽略   | 可选    | 如果这种类型表项出现在共享目标库中，那么这将会改变动态链接器的符号解析算法。动态连接器将首先选择从共享目标文件本身开始搜索符号，只有在搜索失败时，才会选择从可执行文件中搜索相应的符号。 |
| DT_REL                | 17                     | d_ptr | 必需   | 可选    | 此类型表项与 DT_RELA类型的表项类似，只是其表格中包含隐式的补齐，对 32 位文件而言，就是 Elf32_Rel。如果ELF文件中包含此元素，那么动态结构中也必须包含 DT_RELSZ 和 DT_RELENT 类型的元素。 |
| DT_RELSZ              | 18                     | d_val | 必需   | 可选    | 此类型表项包含 DT_REL 重定位表的总字节大小。               |
| DT_RELENT             | 19                     | d_val | 必需   | 可选    | 此类型表项包含 DT_REL 重定位项的字节大小。                |
| DT_PLTREL             | 20                     | d_val | 可选   | 可选    | 此类型表项给出过程链接表所引用的重定位项的类型。根据具体情况， d_val 成员可能包含 DT_REL 或者  DT_RELA。过程链接表中的所有重定位都必须采用相同的重定位方式。 |
| DT_DEBUG              | 21                     | d_ptr | 可选   | 忽略    | 此类型表项用于调试。ABI 未规定其内容，访问这些条目的程序可能与 ABI 不兼容。 |
| DT_TEXTREL            | 22                     | 忽略    | 可选   | 可选    | 如果文件中不包含此类型的表项，则表示没有任何重定位表项能够造成对不可写段的修改。如果存在的话，则可能存在若干重定位项请求对不可写段进行修改，因此，动态链接器可以做相应的准备。 |
| DT_JMPREL             | 23                     | d_ptr | 可选   | 可选    | 如果存在这种类型的表项，则表示条目的 d_ptr 成员包含了某个重定位项的地址，并且该重定位项仅与过程链接表相关。把重定位项分开有利于让动态链接器在进程初始化时忽略它们（开启了延迟绑定）。如果存在此成员，相关的 DT_PLTRELSZ 和  DT_PLTREL 必须也存在。 |
| DT_BIND_NOW           | 24                     | 忽略    | 可选   | 可选    | 如果可执行文件或者共享目标文件中存在此类型的表项的话，动态链接器在将控制权转交给程序前，应该将该文件的所有需要重定位的地址都进行重定位。这个表项的优先权高于延迟绑定，可以通过环境变量或者dlopen(BA_LIB)来设置。 |
| DT_LOPROC  ~DT_HIPROC | 0x70000000 ~0x7fffffff | 未指定   | 未指定  | 未指定   | 这个范围的表项是保留给处理器特定的语义的。                    |

没有出现在此表中的标记值是保留的。此外，除了数组末尾的 DT_NULL 元素以及 DT_NEEDED 元素的相对顺序约束以外， 其他表项可以以任意顺序出现。